<?php

include_once('bbcom_profile.features.inc');

/**
 * Implementation of hook_menu().
 */
function bbcom_profile_menu() {
  $items = array();
  $items['admin/settings/bbcom/profile'] = array(
    'title' => 'Profile',
    'description' => 'Settings for BiblioBird.com Profile module.',
    'access arguments' => array('administer site configuration'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('bbcom_profile_admin_settings'),
    'file' => 'bbcom_profile.admin.inc',
  );
  return $items;
}

/**
 * Implementation of hook_theme().
 */
function bbcom_profile_theme() {
  return array(
    'bbcom_profile_badges' => array(
      'arguments' => array('roles' => NULL),
    )
  );
}

/**
 * Implementation of hook_user().
 */
function bbcom_profile_user($type, &$edit, &$account, $category = NULL) {
  if ($type == 'view') {
    // remove the user picture, because we don't use it!  The styling messes up the layout.
    unset($account->content['user_picture']);

    // integrate the titles and badges
    $roles = array();
    $titles = variable_get('bbcom_profile_role_titles', array());
    foreach ($account->roles as $rid => $role) {
      if (!empty($titles[$rid])) {
        $roles[] = array('rid' => $rid, 'role' => $role, 'title' => $titles[$rid]);
      }
    }
    if (!empty($roles)) {
      $account->content['badges'] = array(
        '#type' => 'user_profile_category',
        '#title' => t('Badges'),
        '#weight' => -1,
      );
      
      $account->content['badges']['badges'] = array(
        '#type' => 'user_profile_item',
        '#value' => theme('bbcom_profile_badges', $roles),
      );
    }
  }
}

/**
 * Implementation of hook_nodeapi().
 */
function bbcom_profile_nodeapi(&$node, $op, $a3 = NULL, $a4 = NULL) {
  if ($node->type == 'profile' && $op == 'presave') {
    $node->title = check_plain(user_load($node->uid)->name);
  }
}

/**
 * Implementation of hook_form_alter().
 */
function bbcom_profile_form_alter(&$form, &$form_state, $form_id) {
  if ($form_id == 'profile_node_form') {
    unset($form['menu']);

    $form['title']['#type'] = 'value';
    $form['title']['#required'] = FALSE;
    $form['#submit'][] = '_bbcom_profile_node_form_submit';
  }
}

function _bbcom_profile_node_form_submit($form, &$form_state) {
  $form_state['value']['title'] = check_plain(user_load($form_state['value']['uid'])->name);
}

/**
 * Implementation of hook_profile_alter().
 */
function bbcom_profile_profile_alter(&$account) {
  // move the content profile to the top of the pile
  $account->content['content_profile']['#weight'] = -2;
}

function bbcom_profile_preprocess_author_pane_user_picture(&$vars) {
  $account =& $vars['account'];
  if ($node = content_profile_load('profile', $account->uid)) {
    $picture = $account->picture = $node->field_profile_image[0]['filepath'];
    $alt = t("@user's picture", array('@user' => $account->name ? $account->name : variable_get('anonymous', t('Anonymous'))));
    $preset = 'tiny';

    $vars['picture'] = theme('imagecache', $preset, $picture, $alt, $alt);
    $vars['imagecache_used'] = TRUE;

  }
}

//////
// Theming

function theme_bbcom_profile_badges($roles) {
  $imgs = array();
  $text = array();
  foreach($roles as $role) {
    $img = str_replace(' ', '-', $role['role']);
    $img = drupal_get_path('module', 'bbcom_profile') .'/badges/'. $img .'.jpg';

    if (file_exists($img)) {
      $imgs[] = theme('image', $img, $role['title'], $role['title'], array('class' => 'bbcom-badge'), TRUE);
    }
    else {
      $text[] = '<div class="bbcom-badge">'. check_plain($role['title']) .'</div>';
    }
  }
  return implode('', $imgs) . implode('', $text);
}

